#!/bin/bash
# ABOUTME: Wrapper script that runs hd rally before launching opencode.
# ABOUTME: Ensures Horde context is available in OpenCode sessions.

set -e

horde_enabled() {
    [[ -n "$HORDE_DISABLED" ]] && return 1
    [[ -n "$HORDE_ENABLED" ]] && return 0
    local state_file="$HOME/.local/state/horde/state.json"
    [[ -f "$state_file" ]] && grep -q '"enabled":\s*true' "$state_file" 2>/dev/null
}

if horde_enabled && command -v hd &>/dev/null; then
    hd rally 2>/dev/null || true
fi

exec opencode "$@"
