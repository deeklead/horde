description = """
Propagate cross-warband dependency resolution.

Dogs work through totems (poured from this ritual) when dependencies resolve across warband boundaries.
When an issue in one warband closes, dependent issues in other warbands may unblock.
This ritual handles:
- Finding cross-warband dependents
- Notifying affected warbands
- Updating blocked status
- Triggering work dispatch if appropriate

## Dog Contract

This is infrastructure work. You:
1. Receive closed issue ID via banner_bead
2. Find all cross-warband dependents (issues in other warbands blocked by this)
3. Notify affected Witnesses
4. Optionally trigger dispatch if issues are now ready
5. Return to kennel

## Variables

| Variable | Source | Description |
|----------|--------|-------------|
| resolved_issue | banner_bead | The issue that just closed |

## Why Dogs?

Cross-warband work requires multi-warband worktrees. Dogs have these, raiders don't.
The Shaman detects the closure, but the propagation needs warband access."""
ritual = "totem-dep-propagate"
version = 1

[squash]
trigger = "on_complete"
template_type = "work"
include_metrics = true

[[steps]]
id = "load-resolved-issue"
title = "Load resolved issue and find dependents"
description = """
Load the closed issue and identify cross-warband dependents.

**1. Check your assignment:**
```bash
hd banner               # Shows banner_bead = resolved issue ID
bd show {{resolved_issue}}  # Full issue details
```

**2. Verify issue is closed:**
```bash
bd show {{resolved_issue}}
# Status should be 'closed' or similar terminal state
```

**3. Find dependents (issues blocked by this one):**
```bash
bd show {{resolved_issue}}
# Look at 'blocks' field - these are issues waiting on this one
```

**4. Identify cross-warband dependents:**
- Same-warband dependents: Already handled by local relics (automatic unblock)
- Cross-warband dependents: Different prefix (e.g., gt- vs bd-) need propagation

```bash
# Example: resolved_issue is bd-xxx, blocks gt-yyy
# gt-yyy is cross-warband and needs notification
```

**Exit criteria:** Resolved issue loaded, cross-warband dependents identified."""

[[steps]]
id = "update-blocked-status"
title = "Update blocked status in affected warbands"
needs = ["load-resolved-issue"]
description = """
Update the blocked status for cross-warband dependents.

**1. For each cross-warband dependent:**
```bash
# Navigate to the warband containing the dependent issue
# Dogs have multi-warband worktrees for this

bd show <dependent-id>
# Check if this was the only blocker
```

**2. Check if now unblocked:**
```bash
bd blocked <dependent-id>
# If empty or only shows other blockers, issue is now unblocked
```

**3. Verify automatic unblock worked:**
Relics should auto-update blocked status when dependencies close.
This step verifies and fixes if needed:
```bash
# If still showing as blocked by resolved issue (shouldn't happen):
bd dep remove <dependent-id> {{resolved_issue}}
```

**Exit criteria:** All cross-warband dependents have updated blocked status."""

[[steps]]
id = "notify-witnesses"
title = "Notify affected warband Witnesses"
needs = ["update-blocked-status"]
description = """
Send notifications to Witnesses of affected warbands.

**1. Group dependents by warband:**
- horde/witness: for gt-* issues
- relics/witness: for bd-* issues
- etc.

**2. For each affected warband, send notification:**
```bash
hd drums send <warband>/witness -s "Dependency resolved: {{resolved_issue}}" -m "$(cat <<EOF
External dependency has closed, unblocking work in your warband.

## Resolved Issue
- ID: {{resolved_issue}}
- Title: {{resolved_issue.title}}
- Warband: {{resolved_issue.prefix}}

## Unblocked in Your Warband
{{range dependent}}
- {{dependent.id}}: {{dependent.title}} ({{dependent.status}})
{{end}}

These issues may now proceed. Check rl ready for available work.
EOF
)"
```

**3. Log notification:**
Note which Witnesses were notified for audit trail.

**Exit criteria:** All affected Witnesses notified."""

[[steps]]
id = "trigger-dispatch"
title = "Optionally trigger work dispatch"
needs = ["notify-witnesses"]
description = """
Trigger work dispatch for newly-unblocked issues if appropriate.

**1. For each unblocked issue, check if ready for work:**
```bash
bd show <issue-id>
# Check:
# - Status: should be 'open' (not already in_progress)
# - Priority: high priority may warrant immediate dispatch
# - No other blockers: rl blocked should be empty
```

**2. Decision: trigger dispatch?**

| Condition | Action |
|-----------|--------|
| High priority (P0-P1) + open + unblocked | Recommend immediate dispatch |
| Medium priority (P2) + open + unblocked | Note in Witness notification |
| Low priority (P3-P4) | Let Witness handle in next scout |

**3. If triggering dispatch:**
```bash
# For high priority, suggest to Warchief:
hd drums send warchief/ -s "High-priority work unblocked: <issue>" -m "..."
```

Usually, the Witness notification (previous step) is sufficient - Witnesses
handle their own dispatch decisions.

**Exit criteria:** Dispatch recommendations sent where appropriate."""

[[steps]]
id = "return-to-kennel"
title = "Signal completion and return to kennel"
needs = ["trigger-dispatch"]
description = """
Signal work complete and return to available pool.

**1. Signal completion to Shaman:**
```bash
hd drums send shaman/ -s "DOG_DONE $(hostname)" -m "Task: dep-propagate
Resolved: {{resolved_issue}}
Cross-warband dependents: {{dependent_count}}
Witnesses notified: {{witness_list}}
Status: COMPLETE

Ready for next assignment."
```

**2. Update activity feed:**
The propagation creates implicit feed entries (dependency updates).
No explicit entry needed.

**3. Return to kennel:**
Dog returns to available state in the pool.

**Exit criteria:** Shaman notified, dog ready for next work or retirement."""

[vars]
[vars.resolved_issue]
description = "The issue ID that just closed and needs propagation"
required = true

